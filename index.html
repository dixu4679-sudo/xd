<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>å¥åº·é¥®é£Ÿé€‰æ‹©å†³ç­–åŠ©æ‰‹ Â· Healthy Food Decision Helper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --primary: #4b7bec;
      --primary-soft: #e4edff;
      --danger: #ff7675;
      --text-main: #2d3436;
      --text-sub: #636e72;
      --border-soft: #dfe6e9;
      --success: #00b894;
      --warning: #e67e22;
    }

    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue",
      Arial, "Noto Sans CJK SC", "Noto Sans KR", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #e3f2fd 0, #f5f7fb 50%, #f5f7fb 100%);
      color: var(--text-main);
    }

    .app {
      max-width: 1100px;
      margin: 24px auto 32px;
      padding: 0 16px;
    }

    /* ===== ç¬¬ 1 å±ï¼šä»‹ç» & è¯­è¨€åˆ‡æ¢ ===== */
    .intro-screen {
      max-width: 780px;
      margin: 0 auto 18px;
      text-align: center;
    }

    .intro-title {
      font-size: 26px;
      margin: 0 0 6px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .intro-subtitle {
      font-size: 14px;
      color: var(--text-sub);
      margin: 0 0 16px;
    }

    .lang-switch {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      font-size: 13px;
    }

    .lang-btn {
      padding: 4px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      font-size: 13px;
      background: #f9fafb;
      cursor: pointer;
      transition: all .15s ease;
    }

    .lang-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: #eef3ff;
    }

    .lang-btn.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .intro-login {
      margin-top: 4px;
      justify-content: center;
    }

    .intro-note {
      margin-top: 10px;
      font-size: 12px;
      color: var(--text-sub);
    }

    /* ===== åŸæœ‰æ ·å¼ï¼ˆç¬¬ 2 å±ï¼‰ ===== */
    header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    h1 {
      margin: 0;
      font-size: 26px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    h1 span.emoji {
      font-size: 30px;
    }

    .subtitle {
      margin: 0;
      font-size: 13px;
      color: var(--text-sub);
      max-width: 600px;
    }

    .login-card {
      background: var(--card);
      border-radius: 14px;
      padding: 10px 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      min-width: 260px;
    }

    .login-card label {
      font-size: 13px;
      white-space: nowrap;
    }

    .login-card input {
      flex: 1;
      min-width: 130px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 6px 10px;
      font-size: 14px;
      outline: none;
    }

    .login-card input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(75,126,236,0.18);
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all .15s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
    }

    .btn-primary:hover {
      filter: brightness(1.05);
      box-shadow: 0 4px 10px rgba(75,126,236,0.4);
      transform: translateY(-1px);
    }

    .current-user {
      font-size: 11px;
      color: var(--text-sub);
      width: 100%;
    }

    main {
      margin-top: 18px;
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(280px, 1fr);
      gap: 16px;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--card);
      border-radius: 14px;
      padding: 16px 18px 18px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      border: 1px solid rgba(255,255,255,0.7);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title span.icon {
      font-size: 18px;
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-sub);
    }

    .field-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .field-row input {
      flex: 1;
      min-width: 140px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 6px 10px;
      font-size: 14px;
      outline: none;
    }

    .field-row input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(75,126,236,0.18);
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    .chip {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 4px 10px;
      font-size: 11px;
      color: var(--text-sub);
      background: #f9fafb;
      cursor: pointer;
      transition: all .12s ease;
    }

    .chip:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: #eef3ff;
    }

    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(165px, 1fr));
      gap: 10px;
      margin-top: 8px;
    }

    .stat-box {
      border-radius: 12px;
      padding: 10px 12px;
      background: #f7f9ff;
      border: 1px solid #dde4ff;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-label {
      color: var(--text-sub);
      font-size: 11px;
    }

    .stat-value {
      font-weight: 600;
      font-size: 14px;
    }

    .badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #ecf0f1;
      color: var(--text-sub);
      margin-left: 4px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      white-space: nowrap;
    }

    .tag-green {
      background: rgba(0,184,148,0.12);
      color: #00b894;
    }

    .tag-orange {
      background: rgba(230,126,34,0.12);
      color: #e67e22;
    }

    .tag-red {
      background: rgba(214,48,49,0.12);
      color: #d63031;
    }

    .health-score {
      font-size: 22px;
      font-weight: 700;
    }

    .health-score.good {
      color: var(--success);
    }

    .health-score.mid {
      color: var(--warning);
    }

    .health-score.bad {
      color: var(--danger);
    }

    .tips {
      font-size: 13px;
      line-height: 1.5;
      margin-top: 4px;
    }

    .empty {
      font-size: 13px;
      color: var(--text-sub);
    }

    .recipes {
      margin-top: 10px;
      font-size: 13px;
      line-height: 1.5;
    }

    .recipes h4 {
      margin: 0 0 4px;
      font-size: 13px;
    }

    .recipes ul {
      margin: 4px 0;
      padding-left: 18px;
    }

    .recipes li {
      margin-bottom: 3px;
    }

    .small {
      font-size: 11px;
      color: var(--text-sub);
    }

    .leaderboard-list {
      list-style: none;
      padding: 0;
      margin: 8px 0 0;
      font-size: 13px;
    }

    .leaderboard-item {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px dashed #ecf0f1;
    }

    .leaderboard-item span.rank {
      width: 22px;
      font-size: 11px;
      color: var(--text-sub);
    }

    .leaderboard-item span.user {
      flex: 1;
      padding-right: 4px;
    }

    .leaderboard-item span.score {
      font-size: 12px;
      color: var(--primary);
      font-weight: 600;
    }

    .user-stats {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 6px;
      margin-top: 6px;
      font-size: 12px;
    }

    .user-stat-item {
      background: #f7f9ff;
      border-radius: 10px;
      padding: 6px 8px;
    }

    .user-stat-label {
      color: var(--text-sub);
      font-size: 11px;
    }

    .user-stat-value {
      font-weight: 600;
      margin-top: 2px;
    }

    canvas {
      max-width: 100%;
    }

    footer {
      margin-top: 18px;
      text-align: center;
      font-size: 11px;
      color: var(--text-sub);
    }

    /* ===== é£Ÿå“è¿è¿çœ‹å°æ¸¸æˆ ===== */
    .food-game-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
      margin-top: 10px;
    }

    .food-card {
      background: #f7f9ff;
      border-radius: 10px;
      border: 1px solid #dde4ff;
      padding: 14px 0;
      text-align: center;
      font-size: 22px;
      cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
      user-select: none;
    }

    .food-card.revealed,
    .food-card.matched {
      background: #ffffff;
      box-shadow: 0 3px 8px rgba(75,126,236,0.18);
    }

    .food-card.matched {
      opacity: 0.7;
      cursor: default;
    }

    .game-stats {
      display: flex;
      justify-content: flex-start;
      gap: 16px;
      font-size: 13px;
      color: var(--text-sub);
    }
  </style>
</head>
<body>
<div class="app">

  <!-- ===== ç¬¬ 1 å±ï¼šä»‹ç» & è¯­è¨€é€‰æ‹© & å¼€å§‹æŒ‰é’® ===== -->
  <section id="introScreen" class="card intro-screen">
    <h2 class="intro-title">
      <span>ğŸ¥—</span> <span id="introTitleText">å¥åº·é¥®é£Ÿé€‰æ‹©å†³ç­–åŠ©æ‰‹</span>
    </h2>
    <p id="introSubtitleText" class="intro-subtitle">
      è¿™æ˜¯ç»Ÿè®¡å†³ç­–è¯¾ç¨‹ä¸­çš„ä¸€ä¸ªå°å‹å¥åº·é¥®é£Ÿå†³ç­–ç³»ç»Ÿã€‚è¯·é€‰æ‹©è¯­è¨€å¹¶ç™»å½•ï¼Œç„¶åè¿›å…¥é£Ÿç‰©æŸ¥è¯¢ã€ç»Ÿè®¡åˆ†æä¸å°æ¸¸æˆå®éªŒç•Œé¢ã€‚
    </p>

    <div class="lang-switch">
      <span>è¯­è¨€ / ì–¸ì–´ :</span>
      <button type="button" class="lang-btn" data-lang="zh">ä¸­æ–‡</button>
      <button type="button" class="lang-btn" data-lang="ko">í•œêµ­ì–´</button>
    </div>

    <div class="login-card intro-login">
      <label for="introUserName">ğŸ‘¤ æ˜µç§° / í•™ë²ˆï¼š</label>
      <input id="introUserName" type="text" placeholder="è¯·è¾“å…¥ä½ çš„åå­—æˆ–å­¦å·">
      <button class="btn btn-primary" id="startBtn">å¼€å§‹ä½¿ç”¨ / ì‹œì‘í•˜ê¸°</button>
    </div>

    <p id="introNoteText" class="intro-note">
      ç™»å½•åç³»ç»Ÿä¼šè®°å½•ä½ çš„æŸ¥è¯¢ä¸æ¸¸æˆè¡Œä¸ºï¼Œä»…ç”¨äºè¯¾å ‚ç»Ÿè®¡åˆ†ææ¼”ç¤ºï¼Œä¸æ¶‰åŠéšç§ã€‚
    </p>
  </section>

  <!-- ===== ç¬¬ 2 å±ï¼šåŸæœ‰ä¸»ç•Œé¢ï¼ˆåˆå§‹åŒ–éšè—ï¼‰ ===== -->
  <section id="mainScreen" style="display:none;">
    <header>
      <div class="title-block">
        <h1><span class="emoji">ğŸ¥—</span> å¥åº·é¥®é£Ÿé€‰æ‹©å†³ç­–åŠ©æ‰‹
          <span style="font-size:14px;color:#636e72;">Healthy Food Decision Helper</span>
        </h1>
        <p class="subtitle">
          è®°å½•ç”¨æˆ·çš„é£Ÿç‰©æŸ¥è¯¢è¡Œä¸ºï¼Œå¯¹é£Ÿç‰©å¥åº·ç¨‹åº¦è¿›è¡Œé‡åŒ–è¯„åˆ†ï¼Œå¹¶é€šè¿‡ Firebase å®æ—¶æ•°æ®åº“ç»Ÿè®¡çƒ­é—¨é£Ÿç‰©ä¸ç”¨æˆ·å¥åº·æŒ‡æ•°ï¼Œ
          ç”¨äºæ”¯æŒä¸ªä½“ä¸ç¾¤ä½“çš„é¥®é£Ÿå†³ç­–ã€‚
        </p>
      </div>

      <div class="login-card">
        <label for="userName">ğŸ‘¤ æ˜µç§° / å­¦å·ï¼š</label>
        <input id="userName" type="text" placeholder="è¯·è¾“å…¥ä½ çš„åå­—">
        <button class="btn btn-primary" id="loginBtn">ç™»å½• / ì‹œì‘í•˜ê¸°</button>
        <div class="current-user" id="currentUser">å½“å‰æœªç™»å½•ï¼ˆå°†ä»¥ Guest è®°å½•æ•°æ®ï¼‰</div>
      </div>
    </header>

    <main>
      <!-- å·¦ä¾§ï¼šæŸ¥è¯¢ä¸ç»“æœ -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span class="icon">ğŸ”</span> é£Ÿç‰©æŸ¥è¯¢ä¸å¥åº·è¯„åˆ† / ì¹¼ë¡œë¦¬Â·ê±´ê°•ë„
            </div>
            <div class="card-subtitle">
              è¾“å…¥å¸¸è§é£Ÿç‰©åç§°ï¼ˆä¾‹å¦‚ï¼šè‹¹æœã€ç‚¸é¸¡ã€æ‹‰é¢ã€æ²™æ‹‰ç­‰ï¼‰ï¼Œç³»ç»Ÿå°†ç»™å‡ºçƒ­é‡ã€è¥å…»ç»“æ„ã€å¥åº·è¯„åˆ†å’Œæ›¿ä»£å»ºè®®ã€‚
            </div>
          </div>
          <button class="btn" id="clearBtn">æ¸…ç©ºç»“æœ</button>
        </div>

        <div class="field-row">
          <input id="foodInput" type="text" placeholder="è¯·è¾“å…¥é£Ÿç‰©ï¼Œå¦‚ï¼šè‹¹æœã€ç‚¸é¸¡ã€æ‹‰é¢â€¦" list="foodSuggestions">
          <button class="btn btn-primary" id="searchBtn">æŸ¥è¯¢</button>
        </div>

        <datalist id="foodSuggestions">
          <option value="è‹¹æœ">
          <option value="é¦™è•‰">
          <option value="æ²™æ‹‰">
          <option value="ç‚¸é¸¡">
          <option value="æ‹‰é¢">
          <option value="æ³¡èœæ±¤">
          <option value="ç´«èœåŒ…é¥­">
          <option value="ç‰›æ²¹æœ">
          <option value="ç™½ç±³é¥­">
          <option value="å¯ä¹">
        </datalist>

        <div class="chip-row">
          <span class="chip" data-food="è‹¹æœ">ğŸ è‹¹æœ</span>
          <span class="chip" data-food="æ²™æ‹‰">ğŸ¥— æ²™æ‹‰</span>
          <span class="chip" data-food="ç‚¸é¸¡">ğŸ— ç‚¸é¸¡</span>
          <span class="chip" data-food="æ‹‰é¢">ğŸœ æ‹‰é¢</span>
          <span class="chip" data-food="ç´«èœåŒ…é¥­">ğŸ™ ç´«èœåŒ…é¥­</span>
          <span class="chip" data-food="ç‰›æ²¹æœ">ğŸ¥‘ ç‰›æ²¹æœ</span>
        </div>

        <div id="resultArea">
          <p class="empty">ğŸ‘‰ è¯·åœ¨ä¸Šæ–¹è¾“å…¥é£Ÿç‰©åç§°å¹¶ç‚¹å‡»â€œæŸ¥è¯¢â€ï¼Œæˆ–ç›´æ¥ç‚¹å‡»ä¸Šæ–¹æ ‡ç­¾ã€‚ç³»ç»Ÿä¼šç»™å‡ºå¥åº·è¯„åˆ†ä¸æ›¿ä»£å»ºè®®ï¼Œå¹¶å°†æœ¬æ¬¡æŸ¥è¯¢è®°å½•è¿›ç»Ÿè®¡æ•°æ®åº“ã€‚</p>
        </div>
      </section>

      <!-- å³ä¾§ï¼šç»Ÿè®¡åˆ†æ -->
      <aside class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span class="icon">ğŸ“Š</span> ç»Ÿè®¡ä¸æ’è¡Œæ¦œ
            </div>
            <div class="card-subtitle">
              åŸºäº Firebase å®æ—¶æ•°æ®åº“ï¼Œç»Ÿè®¡ç”¨æˆ·æŸ¥è¯¢è¡Œä¸ºï¼Œç”¨äºå±•ç¤ºå¥åº·æŒ‡æ•°ä¸ç¾¤ä½“åå¥½ã€‚
            </div>
          </div>
        </div>

        <div>
          <strong>å½“å‰ç”¨æˆ·çš„å¥åº·æŸ¥è¯¢ç»Ÿè®¡</strong>
          <div class="user-stats" id="userStatsArea">
            <div class="user-stat-item">
              <div class="user-stat-label">ç´¯è®¡æŸ¥è¯¢æ¬¡æ•°</div>
              <div class="user-stat-value" id="statTotal">0</div>
            </div>
            <div class="user-stat-item">
              <div class="user-stat-label">å¹³å‡å¥åº·è¯„åˆ†</div>
              <div class="user-stat-value" id="statAvgScore">0</div>
            </div>
            <div class="user-stat-item">
              <div class="user-stat-label">å¥åº·æ¨èæ¬¡æ•°</div>
              <div class="user-stat-value" id="statHigh">0</div>
            </div>
            <div class="user-stat-item">
              <div class="user-stat-label">æ³¨æ„æ§åˆ¶æ¬¡æ•°</div>
              <div class="user-stat-value" id="statLow">0</div>
            </div>
          </div>
          <p class="small">è¯´æ˜ï¼šå¥åº·è¯„åˆ†è¶Šé«˜ï¼Œè¯´æ˜æŸ¥è¯¢çš„é£Ÿç‰©æ•´ä½“è¶Šå¥åº·ã€‚è¯¥æŒ‡æ ‡å¯ç”¨äºè¯„ä¼°ä¸ªä½“é¥®é£Ÿå€¾å‘ã€‚</p>
        </div>

        <hr style="border:none;border-top:1px dashed #ecf0f1;margin:10px 0;">

        <div>
          <strong>ä¼šè¯å†…é£Ÿç‰©ç±»åˆ«åˆ†å¸ƒï¼ˆç¤ºä¾‹ç»Ÿè®¡ï¼‰</strong>
          <canvas id="categoryChart" height="140"></canvas>
          <p class="small">æ­¤å›¾åŸºäºæœ¬æ¬¡æ‰“å¼€é¡µé¢åçš„æŸ¥è¯¢ï¼Œç”¨äºæ¼”ç¤ºå¦‚ä½•å°†è¡Œä¸ºæ•°æ®å¯è§†åŒ–ï¼ˆç»Ÿè®¡å†³ç­–è¯¾ç¨‹å¯é‡ç‚¹è¯´æ˜ï¼‰ã€‚</p>
        </div>

        <hr style="border:none;border-top:1px dashed #ecf0f1;margin:10px 0;">

        <div>
          <strong>å…¨ä½“ç”¨æˆ·å¥åº·æŸ¥è¯¢æ’è¡Œæ¦œ TOP 10</strong>
          <ul class="leaderboard-list" id="leaderboardList">
            <li class="empty">æš‚æ—¶æ²¡æœ‰æ•°æ®ï¼Œè¯·å…ˆè¿›è¡Œå‡ æ¬¡æŸ¥è¯¢ã€‚</li>
          </ul>
          <p class="small">æ’åºè§„åˆ™ï¼šæŒ‰â€œå¥åº·æ¨èâ€é£Ÿç‰©çš„ç´¯è®¡æŸ¥è¯¢æ¬¡æ•°æ’åºï¼Œç”¨äºåæ˜ å“ªäº›ç”¨æˆ·æ•´ä½“é¥®é£Ÿå†³ç­–æ›´åå¥åº·ã€‚</p>
        </div>
      </aside>
    </main>

    <!-- é£Ÿå“è¿è¿çœ‹ Mini Game -->
    <section class="card" id="gameCard" style="margin-top:16px;">
      <div class="card-header">
        <div>
          <div class="card-title"><span class="icon">ğŸ®</span> é£Ÿå“è¿è¿çœ‹ Â· Mini Game</div>
          <div class="card-subtitle">ç‚¹å‡»ä¸¤å¼ ç›¸åŒçš„é£Ÿç‰©å¡ç‰‡å³å¯é…å¯¹æ¶ˆé™¤ï¼Œçœ‹çœ‹ä½ èƒ½åœ¨å¤šå°‘æ­¥å†…å®Œæˆã€‚</div>
        </div>
        <button class="btn btn-ghost" id="resetGameBtn">é‡æ–°å¼€å§‹</button>
      </div>

      <div class="game-stats">
        <span>æ­¥æ•°ï¼š<strong id="gameMoves">0</strong></span>
        <span>å®Œæˆå¯¹æ•°ï¼š<strong id="gameMatches">0</strong> / <span id="gameTotalPairs">0</span></span>
      </div>

      <div id="foodGameGrid" class="food-game-grid">
        <!-- JS ç”Ÿæˆå¡ç‰‡ -->
      </div>

      <p class="card-subtitle" style="margin-top:8px;font-size:12px;">
        å°æç¤ºï¼šæ¸¸æˆç»“æŸåä¼šå°†ä½ çš„æˆç»©ï¼ˆæ­¥æ•°ä¸å®Œæˆæ—¶é—´ï¼‰å†™å…¥ Firebaseï¼Œç”¨äºç»Ÿè®¡å¤§å®¶å¯¹ä¸åŒé£Ÿç‰©çš„ç†Ÿæ‚‰ç¨‹åº¦ã€‚
      </p>
    </section>

    <footer>
      Â© 2025 å¥åº·é¥®é£Ÿé€‰æ‹©å†³ç­–åŠ©æ‰‹ Â· ä½¿ç”¨ Firebase Realtime Database æ”¶é›†ä¸å±•ç¤ºç»Ÿè®¡æ•°æ®
    </footer>
  </section>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<!-- Chart.js ç”¨äºå¯è§†åŒ– -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // ===== Firebase é…ç½® =====
  const firebaseConfig = {
    apiKey: "AIzaSyBCrHD2f3beCX83FZwpCCqMf2lT7WeF8Lg",
    authDomain: "healthy-eating-and-recreation.firebaseapp.com",
    databaseURL: "https://healthy-eating-and-recreation-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "healthy-eating-and-recreation",
    storageBucket: "healthy-eating-and-recreation.appspot.com",
    messagingSenderId: "282757556302",
    appId: "1:282757556302:web:df373651ffe71efca1bb1f",
    measurementId: "G-BPG2KSLHF7"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ===== ç¬¬ 1 å±ï¼šè¯­è¨€ & è¿›å…¥ä¸»ç•Œé¢ =====
  const introScreen = document.getElementById("introScreen");
  const mainScreen  = document.getElementById("mainScreen");
  const startBtn = document.getElementById("startBtn");
  const introUserName = document.getElementById("introUserName");
  const langButtons = document.querySelectorAll(".lang-btn");
  const introTitleText = document.getElementById("introTitleText");
  const introSubtitleText = document.getElementById("introSubtitleText");
  const introNoteText = document.getElementById("introNoteText");

  const I18N = {
    zh: {
      title: "å¥åº·é¥®é£Ÿé€‰æ‹©å†³ç­–åŠ©æ‰‹",
      subtitle: "è¿™æ˜¯ç»Ÿè®¡å†³ç­–è¯¾ç¨‹ä¸­çš„ä¸€ä¸ªå°å‹å¥åº·é¥®é£Ÿå†³ç­–ç³»ç»Ÿã€‚è¯·é€‰æ‹©è¯­è¨€å¹¶ç™»å½•ï¼Œç„¶åè¿›å…¥é£Ÿç‰©æŸ¥è¯¢ã€ç»Ÿè®¡åˆ†æä¸å°æ¸¸æˆå®éªŒç•Œé¢ã€‚",
      note: "ç™»å½•åç³»ç»Ÿä¼šè®°å½•ä½ çš„æŸ¥è¯¢ä¸æ¸¸æˆè¡Œä¸ºï¼Œä»…ç”¨äºè¯¾å ‚ç»Ÿè®¡åˆ†ææ¼”ç¤ºï¼Œä¸æ¶‰åŠéšç§ã€‚",
      startBtn: "å¼€å§‹ä½¿ç”¨ / ì‹œì‘í•˜ê¸°",
      placeholder: "è¯·è¾“å…¥ä½ çš„åå­—æˆ–å­¦å·",
      needName: "è¯·å…ˆè¾“å…¥æ˜µç§°æˆ–å­¦å·ã€‚"
    },
    ko: {
      title: "ê±´ê°• ì‹ë‹¨ ì„ íƒ ì˜ì‚¬ê²°ì • ë„ìš°ë¯¸",
      subtitle: "ì´ ì›¹ì•±ì€ í†µê³„ì  ì˜ì‚¬ê²°ì • ìˆ˜ì—…ì„ ìœ„í•œ ê±´ê°• ì‹ë‹¨ ê²°ì • ì‹œìŠ¤í…œì…ë‹ˆë‹¤. ì–¸ì–´ë¥¼ ì„ íƒí•˜ê³  ë¡œê·¸ì¸í•œ í›„, ì‹í’ˆ ê²€ìƒ‰Â·í†µê³„Â·ë¯¸ë‹ˆê²Œì„ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.",
      note: "ë¡œê·¸ì¸ í›„ì˜ ì¡°íšŒì™€ ê²Œì„ ê¸°ë¡ì€ ìˆ˜ì—…ì—ì„œ í†µê³„ ì˜ˆì‹œë¡œë§Œ ì‚¬ìš©ë˜ë©°, ê°œì¸ì •ë³´ì—ëŠ” ì´ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.",
      startBtn: "ì‹œì‘í•˜ê¸° / Start",
      placeholder: "ì´ë¦„ ë˜ëŠ” í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”",
      needName: "ì´ë¦„ ë˜ëŠ” í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”."
    }
  };

  let currentLang = "zh";

  function applyLanguage() {
    const t = I18N[currentLang];
    introTitleText.textContent = t.title;
    introSubtitleText.textContent = t.subtitle;
    introNoteText.textContent = t.note;
    startBtn.textContent = t.startBtn;
    introUserName.placeholder = t.placeholder;
  }

  langButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      langButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      currentLang = btn.dataset.lang || "zh";
      applyLanguage();
    });
  });

  // é»˜è®¤ä¸­æ–‡é«˜äº®
  document.querySelector('.lang-btn[data-lang="zh"]').classList.add("active");
  applyLanguage();

  // ===== åŸæœ‰ DOM å¼•ç”¨ï¼ˆç¬¬ 2 å±ï¼‰ =====
  const userNameInput = document.getElementById("userName");
  const loginBtn = document.getElementById("loginBtn");
  const currentUserLabel = document.getElementById("currentUser");
  const foodInput = document.getElementById("foodInput");
  const searchBtn = document.getElementById("searchBtn");
  const clearBtn = document.getElementById("clearBtn");
  const resultArea = document.getElementById("resultArea");
  const chips = document.querySelectorAll(".chip");
  const leaderboardList = document.getElementById("leaderboardList");

  const statTotal = document.getElementById("statTotal");
  const statAvgScore = document.getElementById("statAvgScore");
  const statHigh = document.getElementById("statHigh");
  const statLow = document.getElementById("statLow");

  // å…¨å±€çŠ¶æ€
  let currentUser = null;
  let currentUserKey = "Guest";
  let categoryCount = {}; // æœ¬æ¬¡ä¼šè¯ä¸­ï¼Œå„ç±»åˆ«æŸ¥è¯¢æ¬¡æ•°ï¼ˆç”¨äº Chartï¼‰

  // ===== ç‚¹å‡»â€œå¼€å§‹ä½¿ç”¨â€ â†’ è®¾ç½®ç”¨æˆ·åå¹¶è¿›å…¥ä¸»ç•Œé¢ =====
  startBtn.addEventListener("click", () => {
    const t = I18N[currentLang];
    const name = introUserName.value.trim();
    if (!name) {
      alert(t.needName);
      introUserName.focus();
      return;
    }
    // æŠŠåå­—å†™å…¥ç¬¬äºŒå±çš„è¾“å…¥æ¡†ï¼Œå¤ç”¨åŸæ¥çš„ç™»å½•é€»è¾‘
    userNameInput.value = name;
    introScreen.style.display = "none";
    mainScreen.style.display  = "block";
    window.scrollTo({ top: 0, behavior: "smooth" });
    loginBtn.click(); // è§¦å‘åŸæ¥çš„ç™»å½•æµç¨‹
  });

  // ===== ç®€åŒ–ç‰ˆé£Ÿç‰©æ•°æ®åº“ =====
  const FOOD_DATA = {
    "è‹¹æœ": {
      nameCN: "è‹¹æœ", nameEN: "Apple",
      kcal: 52, carbs: 14, protein: 0.3, fat: 0.2, fiber: 2.4,
      category: "æ°´æœ", healthLevel: "high",
      tips: "å¯Œå«ç»´ç”Ÿç´ Cå’Œè†³é£Ÿçº¤ç»´ï¼Œå¯ä½œä¸ºåŠ é¤æˆ–æ—©é¤é…é¤ã€‚",
      recipes: ["é…¸å¥¶æ°´æœç¢—ï¼šåŸå‘³é…¸å¥¶ + è‹¹æœ + ç‡•éº¦ + åšæœã€‚"]
    },
    "é¦™è•‰": {
      nameCN: "é¦™è•‰", nameEN: "Banana",
      kcal: 89, carbs: 23, protein: 1.1, fat: 0.3, fiber: 2.6,
      category: "æ°´æœ", healthLevel: "medium",
      tips: "èƒ½é‡å¯†åº¦è¾ƒé«˜ï¼Œé€‚åˆè¿åŠ¨å‰åè¡¥å……èƒ½é‡ï¼Œå‡è„‚æœŸæ³¨æ„æ€»é‡ã€‚",
      recipes: ["é¦™è•‰èŠ±ç”Ÿé…±å…¨éº¦åå¸ã€‚"]
    },
    "æ²™æ‹‰": {
      nameCN: "è”¬èœæ²™æ‹‰", nameEN: "Green Salad",
      kcal: 35, carbs: 5, protein: 1.5, fat: 1, fiber: 2.5,
      category: "è”¬èœ/è½»é£Ÿ", healthLevel: "high",
      tips: "ä¼˜å…ˆé€‰æ‹©æ©„æ¦„æ²¹ã€æŸ æª¬æ±ç­‰æ¸…çˆ½é…±æ±ï¼Œé¿å…é«˜ç³–é«˜è„‚æ²™æ‹‰é…±ã€‚",
      recipes: ["é¸¡èƒ¸è‚‰æ··åˆè”¬èœæ²™æ‹‰ã€‚"]
    },
    "ç‚¸é¸¡": {
      nameCN: "ç‚¸é¸¡", nameEN: "Fried Chicken",
      kcal: 260, carbs: 8, protein: 18, fat: 17, fiber: 0,
      category: "æ²¹ç‚¸é£Ÿå“", healthLevel: "low",
      tips: "é«˜è„‚ã€é«˜çƒ­é‡ï¼Œå»ºè®®å¶å°”å°‘é‡äº«ç”¨ï¼Œå¯ç”¨çƒ¤ç®±ç‰ˆé¸¡å—æ›¿ä»£ã€‚",
      recipes: ["çƒ¤ç®±ä½æ²¹é¸¡å—ï¼šç”¨å°‘é‡æ²¹+çƒ¤ç®±ä»£æ›¿æ²¹ç‚¸ã€‚"]
    },
    "æ‹‰é¢": {
      nameCN: "æ–¹ä¾¿æ‹‰é¢", nameEN: "Instant Ramen",
      kcal: 450, carbs: 60, protein: 9, fat: 17, fiber: 3,
      category: "ä¸»é£Ÿ/å¿«é¤", healthLevel: "low",
      tips: "é’ å«é‡é«˜ï¼Œå¯åªç”¨ä¸€åŠè°ƒæ–™åŒ…ï¼Œå¹¶é¢å¤–åŠ å…¥è”¬èœå’Œè›‹ã€‚",
      recipes: ["è”¬èœé¸¡è›‹æ‹‰é¢ï¼šåŠ é’èœã€èƒ¡èåœä¸ã€é¸¡è›‹ã€‚"]
    },
    "æ³¡èœæ±¤": {
      nameCN: "æ³¡èœæ±¤", nameEN: "Kimchi Stew",
      kcal: 80, carbs: 6, protein: 6, fat: 3, fiber: 1.5,
      category: "éŸ©å¼èœè‚´", healthLevel: "medium",
      tips: "æ­é…å°‘é‡ç±³é¥­å’Œè±†è…ã€ç˜¦è‚‰ï¼Œå¯ä»¥æˆä¸ºè¾ƒå‡è¡¡çš„ä¸€é¤ã€‚",
      recipes: ["è±†è…çŒªè‚‰æ³¡èœæ±¤ã€‚"]
    },
    "ç´«èœåŒ…é¥­": {
      nameCN: "ç´«èœåŒ…é¥­", nameEN: "Gimbap",
      kcal: 200, carbs: 30, protein: 5, fat: 6, fiber: 2,
      category: "ä¸»é£Ÿ/ä¾¿å½“", healthLevel: "medium",
      tips: "å¤šé€‰æ‹©è”¬èœå’Œé¸¡è›‹ä¸ºä¸»çš„å†…é¦…ï¼Œå°‘ç”¨åŠ å·¥è‚‰ç±»ã€‚",
      recipes: ["è”¬èœé¸¡è›‹ç´«èœåŒ…é¥­ã€‚"]
    },
    "ç‰›æ²¹æœ": {
      nameCN: "ç‰›æ²¹æœ", nameEN: "Avocado",
      kcal: 160, carbs: 9, protein: 2, fat: 15, fiber: 7,
      category: "ä¼˜è´¨è„‚è‚ª", healthLevel: "high",
      tips: "å«æœ‰ä¸°å¯Œå•ä¸é¥±å’Œè„‚è‚ªé…¸å’Œçº¤ç»´ï¼Œå¯ä¸å…¨éº¦é¢åŒ…æ­é…ã€‚",
      recipes: ["ç‰›æ²¹æœé¸¡è›‹åå¸ã€‚"]
    },
    "ç™½ç±³é¥­": {
      nameCN: "ç™½ç±³é¥­", nameEN: "White Rice",
      kcal: 130, carbs: 28, protein: 2.4, fat: 0.3, fiber: 0.4,
      category: "ä¸»é£Ÿ", healthLevel: "medium",
      tips: "æ§åˆ¶ä»½é‡ï¼Œæ­é…è¶³å¤Ÿè”¬èœå’Œè›‹ç™½è´¨ï¼Œä»ç„¶å¯ä»¥æ˜¯å¥åº·é¥®é£Ÿçš„ä¸€éƒ¨åˆ†ã€‚",
      recipes: ["ä¸€ç¢—ç±³é¥­ + è”¬èœ + è›‹ç™½è´¨é£Ÿç‰©ã€‚"]
    },
    "å¯ä¹": {
      nameCN: "å¯ä¹é¥®æ–™", nameEN: "Cola",
      kcal: 42, carbs: 11, protein: 0, fat: 0, fiber: 0,
      category: "å«ç³–é¥®æ–™", healthLevel: "low",
      tips: "å‡ ä¹åªæä¾›ç³–åˆ†ä¸çƒ­é‡ï¼Œå»ºè®®ç”¨æ— ç³–æ°”æ³¡æ°´æˆ–èŒ¶é¥®æ›¿ä»£ã€‚",
      recipes: ["æŸ æª¬ç‰‡æ— ç³–æ°”æ³¡æ°´ã€‚"]
    }
  };

  // Chart.js åˆå§‹åŒ–
  let categoryChart = null;
  function updateCategoryChart() {
    const labels = Object.keys(categoryCount);
    const data = labels.map(k => categoryCount[k]);
    const ctx = document.getElementById("categoryChart").getContext("2d");

    if (categoryChart) categoryChart.destroy();
    categoryChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'ä¼šè¯å†…æŸ¥è¯¢æ¬¡æ•°',
          data
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: { ticks: { font: { size: 11 } } },
          y: { beginAtZero: true, ticks: { stepSize: 1 } }
        }
      }
    });
  }

  // ===== ç™»å½•é€»è¾‘ï¼ˆç¬¬ 2 å±ï¼Œå¯ä»¥å†æ¬¡ä¿®æ”¹æ˜µç§°ï¼‰ =====
  loginBtn.addEventListener("click", () => {
    const name = userNameInput.value.trim();
    if (!name) {
      alert("è¯·å…ˆè¾“å…¥ä½ çš„æ˜µç§°æˆ–å­¦å·ã€‚");
      userNameInput.focus();
      return;
    }
    currentUser = name;
    currentUserKey = sanitizeKey(name);
    currentUserLabel.textContent = "å½“å‰ç”¨æˆ·ï¼š" + currentUser + "ï¼ˆæ•°æ®å°†æŒ‰æ­¤åç§°ç»Ÿè®¡ï¼‰";
    fetchUserStatsOnce();
  });

  userNameInput.addEventListener("keydown", e => {
    if (e.key === "Enter") loginBtn.click();
  });

  // ===== æŸ¥è¯¢é€»è¾‘ =====
  searchBtn.addEventListener("click", () => {
    const name = foodInput.value.trim();
    if (!name) {
      alert("è¯·è¾“å…¥é£Ÿç‰©åç§°ã€‚");
      return;
    }
    handleSearch(name);
  });

  foodInput.addEventListener("keydown", e => {
    if (e.key === "Enter") searchBtn.click();
  });

  chips.forEach(chip => {
    chip.addEventListener("click", () => {
      const foodName = chip.getAttribute("data-food");
      foodInput.value = foodName;
      handleSearch(foodName);
    });
  });

  clearBtn.addEventListener("click", () => {
    resultArea.innerHTML = '<p class="empty">ğŸ‘‰ å·²æ¸…ç©ºç»“æœï¼Œè¯·é‡æ–°è¾“å…¥é£Ÿç‰©åç§°è¿›è¡ŒæŸ¥è¯¢ã€‚</p>';
  });

  function handleSearch(rawName) {
    const key = rawName.replace(/\s+/g, "");
    const data = FOOD_DATA[key];
    if (!data) {
      resultArea.innerHTML = `
        <p class="empty">æš‚æœªæ”¶å½• <strong>${escapeHtml(rawName)}</strong> çš„è¯¦ç»†ä¿¡æ¯ã€‚<br>
        åœ¨è¯¾ç¨‹æŠ¥å‘Šä¸­å¯ä»¥è¯´æ˜ï¼šæœ¬ç³»ç»Ÿä¸ºæ•™å­¦ç¤ºä¾‹ï¼Œåªæ”¶å½•äº†å¸¸è§é£Ÿç‰©ï¼ˆè‹¹æœã€æ²™æ‹‰ã€ç‚¸é¸¡ã€æ‹‰é¢ç­‰ï¼‰ã€‚</p>
      `;
      return;
    }

    const healthScore = computeHealthScore(data);
    const levelTag = getHealthTag(healthScore, data.healthLevel);
    const suggestion = getSuggestionText(healthScore, data);

    renderFoodResult(data, healthScore, levelTag, suggestion);

    categoryCount[data.category] = (categoryCount[data.category] || 0) + 1;
    updateCategoryChart();

    const user = currentUser || "Guest";
    const userKey = currentUser ? currentUserKey : "Guest";
    const payload = {
      user,
      userKey,
      foodKey: key,
      foodName: data.nameCN,
      category: data.category,
      healthScore,
      healthLevel: data.healthLevel,
      timestamp: Date.now()
    };
    try {
      db.ref("foodSearchLogs").push(payload);
      updateUserStats(userKey, healthScore);
    } catch (e) {
      console.warn("å†™å…¥ Firebase å‡ºé”™ï¼š", e);
    }
  }

  function computeHealthScore(food) {
    let base = 70;
    if (food.healthLevel === "high") base = 90;
    else if (food.healthLevel === "medium") base = 70;
    else base = 50;

    if (food.kcal > 300) base -= 10;
    if (food.kcal > 450) base -= 15;
    if (food.kcal < 120 && food.healthLevel !== "low") base += 5;
    if (food.category === "å«ç³–é¥®æ–™") base -= 10;

    return Math.max(0, Math.min(100, base));
  }

  function getHealthTag(score, level) {
    let cls = "tag-green";
    let text = "å¥åº·æ¨è";
    if (score >= 80) {
      cls = "tag-green"; text = "å¥åº·æ¨è";
    } else if (score >= 60) {
      cls = "tag-orange"; text = "é€‚é‡é£Ÿç”¨";
    } else {
      cls = "tag-red"; text = "æ³¨æ„æ§åˆ¶";
    }
    return `<span class="tag ${cls}">${text}</span>`;
  }

  function getSuggestionText(score, food) {
    if (score >= 80) {
      return "æ€»ä½“æ¥è¯´ï¼Œè¯¥é£Ÿç‰©è¾ƒä¸ºå¥åº·ï¼Œå¯ä½œä¸ºæ—¥å¸¸é¥®é£Ÿçš„ä¸€éƒ¨åˆ†ã€‚ä»éœ€æ³¨æ„æ•´ä½“èƒ½é‡ä¸æ­é…å‡è¡¡ã€‚";
    } else if (score >= 60) {
      return "é€‚åˆä½œä¸ºå¶å°”æˆ–é€‚é‡é€‰æ‹©ã€‚å¯ä»¥æ­é…è”¬èœã€è›‹ç™½è´¨é£Ÿç‰©ä¸€èµ·ï¼Œé¿å…æ•´é¤è¿‡äºå•ä¸€ã€‚";
    } else {
      if (food.category === "å«ç³–é¥®æ–™") {
        return "è¯¥é¥®å“ä¸»è¦æä¾›ç³–å’Œçƒ­é‡ï¼Œè¥å…»ä»·å€¼æœ‰é™ã€‚å»ºè®®å‡å°‘é¢‘ç‡ï¼Œå¯å°è¯•æ— ç³–èŒ¶é¥®æˆ–æ°”æ³¡æ°´æ›¿ä»£ã€‚";
      }
      if (food.category === "æ²¹ç‚¸é£Ÿå“" || food.category === "ä¸»é£Ÿ/å¿«é¤") {
        return "èƒ½é‡å’Œè„‚è‚ªå«é‡è¾ƒé«˜ï¼Œå»ºè®®æ§åˆ¶ä»½é‡ä¸é£Ÿç”¨é¢‘ç‡ï¼Œå¯åœ¨æŠ¥å‘Šä¸­å°†å…¶å½’ç±»ä¸ºâ€œé«˜é£é™©é€‰æ‹©â€ã€‚";
      }
      return "ç»¼åˆè¥å…»ç»“æ„æ¥çœ‹ï¼Œè¯¥é£Ÿç‰©éœ€è¦æ³¨æ„æ‘„å…¥é‡ä¸é¢‘æ¬¡ï¼Œå¯ä¸ä½èƒ½é‡ã€é«˜çº¤ç»´é£Ÿç‰©æ­é…ã€‚";
    }
  }

  function renderFoodResult(data, score, tagHtml, suggestion) {
    const recipesHtml = (data.recipes || []).length
      ? `<div class="recipes"><h4>ğŸ½ æ¨èåƒæ³•ï¼ˆç¤ºä¾‹ï¼‰</h4><ul>${
          data.recipes.map(r => `<li>${escapeHtml(r)}</li>`).join("")
        }</ul></div>`
      : "";

    const scoreClass = score >= 80 ? "good" : score >= 60 ? "mid" : "bad";

    resultArea.innerHTML = `
      <div class="result-grid">
        <div class="stat-box">
          <div class="stat-label">é£Ÿç‰©åç§°</div>
          <div class="stat-value">
            ${escapeHtml(data.nameCN)}<span class="badge">${escapeHtml(data.nameEN)}</span>
          </div>
          <div class="tips">ç±»åˆ«ï¼š${escapeHtml(data.category)} ${tagHtml}</div>
        </div>

        <div class="stat-box">
          <div class="stat-label">èƒ½é‡ä¸è¥å…»ç»“æ„</div>
          <div class="stat-value">${data.kcal} kcal / 100g</div>
          <div class="tips">ç¢³æ°´ ${data.carbs}g Â· è›‹ç™½è´¨ ${data.protein}g Â· è„‚è‚ª ${data.fat}g Â· çº¤ç»´ ${data.fiber}g</div>
        </div>

        <div class="stat-box">
          <div class="stat-label">å¥åº·è¯„åˆ†ï¼ˆ0â€“100ï¼‰</div>
          <div class="health-score ${scoreClass}">${score.toFixed(0)}</div>
          <div class="tips">åŸºäºçƒ­é‡ã€è„‚è‚ªã€ç³–åˆ†ä¸é£Ÿç‰©ç±»åˆ«æ„å»ºçš„ç®€åŒ–è¯„åˆ†æ¨¡å‹ï¼Œå¯åœ¨æŠ¥å‘Šä¸­ä½œä¸ºç»Ÿè®¡å†³ç­–ç¤ºä¾‹ã€‚</div>
        </div>

        <div class="stat-box">
          <div class="stat-label">ç®€å•å»ºè®®</div>
          <div class="tips">${escapeHtml(suggestion)}</div>
        </div>
      </div>
      ${recipesHtml}
    `;
  }

  // ===== ç”¨æˆ·ç»Ÿè®¡ =====
  function updateUserStats(userKey, healthScore) {
    const ref = db.ref("userStats/" + userKey);
    ref.transaction(stat => {
      if (!stat) {
        stat = {
          userName: currentUser || "Guest",
          total: 0,
          sumScore: 0,
          high: 0,
          mid: 0,
          low: 0
        };
      }
      stat.total += 1;
      stat.sumScore += healthScore;
      if (healthScore >= 80) stat.high += 1;
      else if (healthScore >= 60) stat.mid += 1;
      else stat.low += 1;
      return stat;
    }, (err, committed, snap) => {
      if (snap && userKey === currentUserKey) {
        renderUserStats(snap.val());
      }
    });
  }

  function fetchUserStatsOnce() {
    if (!currentUserKey) return;
    db.ref("userStats/" + currentUserKey).once("value").then(snap => {
      if (snap.exists()) {
        renderUserStats(snap.val());
      } else {
        renderUserStats(null);
      }
    });
  }

  function renderUserStats(stat) {
    if (!stat) {
      statTotal.textContent = "0";
      statAvgScore.textContent = "0";
      statHigh.textContent = "0";
      statLow.textContent = "0";
      return;
    }
    const avg = stat.total > 0 ? (stat.sumScore / stat.total).toFixed(1) : 0;
    statTotal.textContent = stat.total;
    statAvgScore.textContent = avg;
    statHigh.textContent = stat.high || 0;
    statLow.textContent = stat.low || 0;
  }

  // ===== æ’è¡Œæ¦œ =====
  db.ref("userStats").on("value", snapshot => {
    const val = snapshot.val();
    if (!val) {
      leaderboardList.innerHTML = '<li class="empty">æš‚æ—¶æ²¡æœ‰æ•°æ®ï¼Œè¯·å…ˆè¿›è¡Œå‡ æ¬¡æŸ¥è¯¢ã€‚</li>';
      return;
    }
    const arr = Object.keys(val).map(k => val[k]);
    arr.sort((a, b) => (b.high || 0) - (a.high || 0));
    const top10 = arr.slice(0, 10);

    leaderboardList.innerHTML = "";
    top10.forEach((u, idx) => {
      const li = document.createElement("li");
      li.className = "leaderboard-item";
      li.innerHTML = `
        <span class="rank">${idx + 1}.</span>
        <span class="user">${escapeHtml(u.userName || "æœªå‘½å")}</span>
        <span class="score">${u.high || 0} æ¬¡å¥åº·é€‰æ‹©</span>
      `;
      leaderboardList.appendChild(li);
    });
  });

  // ===== é£Ÿå“è¿è¿çœ‹ Mini Game =====
  const FOOD_ICONS = ["ğŸ","ğŸ”","ğŸ¥—","ğŸ£","ğŸŸ","ğŸ¥","ğŸ¥¦","ğŸ«"]; // 8 å¯¹ï¼Œ4x4
  let gameCards = [];
  let firstCard = null;
  let secondCard = null;
  let lockBoard = false;
  let gameMoves = 0;
  let gameMatches = 0;
  let gameStartTime = null;

  const gridEl = document.getElementById("foodGameGrid");
  const movesEl = document.getElementById("gameMoves");
  const matchesEl = document.getElementById("gameMatches");
  const totalPairsEl = document.getElementById("gameTotalPairs");
  const resetGameBtn = document.getElementById("resetGameBtn");

  function initFoodGame() {
    if (!gridEl) return;
    const icons = [...FOOD_ICONS, ...FOOD_ICONS];
    icons.sort(() => Math.random() - 0.5);

    gridEl.innerHTML = "";
    gameCards = [];
    firstCard = null;
    secondCard = null;
    lockBoard = false;
    gameMoves = 0;
    gameMatches = 0;
    movesEl.textContent = "0";
    matchesEl.textContent = "0";
    totalPairsEl.textContent = FOOD_ICONS.length;
    gameStartTime = Date.now();

    icons.forEach((icon, index) => {
      const div = document.createElement("div");
      div.className = "food-card";
      div.dataset.icon = icon;
      div.dataset.index = index;
      div.textContent = "â“";
      div.addEventListener("click", onFoodCardClick);
      gridEl.appendChild(div);
      gameCards.push(div);
    });
  }

  function onFoodCardClick(e) {
    const card = e.currentTarget;
    if (lockBoard) return;
    if (card.classList.contains("matched")) return;
    if (card === firstCard) return;

    revealCard(card);

    if (!firstCard) {
      firstCard = card;
      return;
    }

    secondCard = card;
    gameMoves++;
    movesEl.textContent = String(gameMoves);
    checkMatch();
  }

  function revealCard(card) {
    card.classList.add("revealed");
    card.textContent = card.dataset.icon;
  }

  function hideCard(card) {
    card.classList.remove("revealed");
    card.textContent = "â“";
  }

  function checkMatch() {
    const isMatch = firstCard.dataset.icon === secondCard.dataset.icon;

    if (isMatch) {
      firstCard.classList.add("matched");
      secondCard.classList.add("matched");
      gameMatches++;
      matchesEl.textContent = String(gameMatches);
      resetTurn();

      if (gameMatches === FOOD_ICONS.length) {
        const durationSec = Math.round((Date.now() - gameStartTime) / 1000);
        alert(`å®Œæˆï¼æ€»æ­¥æ•°ï¼š${gameMoves}ï¼Œè€—æ—¶çº¦ ${durationSec} ç§’`);

        try {
          if (typeof db !== "undefined") {
            db.ref("foodMatchGameLogs").push({
              user: currentUser || "Guest",
              moves: gameMoves,
              durationSec,
              timestamp: Date.now()
            });
          }
        } catch (err) {
          console.warn("å†™å…¥ foodMatchGameLogs å‡ºé”™ï¼š", err);
        }
      }
    } else {
      lockBoard = true;
      setTimeout(() => {
        hideCard(firstCard);
        hideCard(secondCard);
        resetTurn();
      }, 700);
    }
  }

  function resetTurn() {
    [firstCard, secondCard] = [null, null];
    lockBoard = false;
  }

  if (gridEl) {
    initFoodGame();
  }

  if (resetGameBtn) {
    resetGameBtn.addEventListener("click", initFoodGame);
  }

  // ===== å·¥å…·å‡½æ•° =====
  function sanitizeKey(str) {
    return String(str).replace(/[.#$[\]]/g, "_");
  }

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, m => {
      switch (m) {
        case "&": return "&amp;";
        case "<": return "&lt;";
        case ">": return "&gt;";
        case '"': return "&quot;";
        case "'": return "&#39;";
        default: return m;
      }
    });
  }
</script>
</body>
</html>
